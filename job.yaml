- defaults:
    name: global
    project-type: freestyle
    concurrent: false
    disabled: false
    block-downstream: false
    block-upstream: false
    logrotate:
      daysToKeep: -1
      numToKeep: 200
      artifactDaysToKeep: -1
      artifactNumToKeep: -1

- builder:
    name: setup-jail
    builders:
      - shell: |
          export jname=${JOB_NAME}
          
          fetch ftp://ftp0.twn.freebsd.org:/pub/FreeBSD/releases/amd64/10.1-RELEASE/base.txz
          fetch ftp://ftp0.twn.freebsd.org:/pub/FreeBSD/releases/amd64/10.1-RELEASE/lib32.txz
          
          mkdir ${jname}
          
          cd ${jname}
          tar Jxf ../base.txz
          tar Jxf ../lib32.txz
          cd -
          
          sudo mount -t devfs devfs ${jname}/dev
          sudo devfs -m ${jname}/dev rule -s 4 applyset
          
          sudo mount -t nullfs src ${jname}/usr/src
          
          sudo jail -c persist name="${jname}" path="${jname}" host.hostname="${jname}" ip6=disable ip4=disable allow.chflags

- builder:
    name: make
    builders:
      - shell: |
          export jname=${JOB_NAME}
          sudo jexec ${jname} sh -c "cd /usr/src && make -j {jflag} {target}"

- builder:
    name: make-world
    builders:
      - make:
        jflag: 4
        target: buildworld

- builder:
    name: make-kernel
    builders:
      - make:
        jflag: 4
        target: buildkernel

- job:
    name: test-jail
    defaults: global
    builders:
      - setup-jail
      - make-world
      - make-kernel
