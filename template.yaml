- job-template:
    defaults: global
    name: 'FreeBSD-{branch}-{arch}-build'
    node: jailer_fast
    scm:
      - 'FreeBSD-src-{branch}'
    triggers:
      - pollscm: H/5 * * * *
    properties:
      - inject:
          properties-content: |
            FBSD_BRANCH={branch}
            MOUNT_REPO=src
    builders:
      - checkout-scripts
      - setup-jail
      - execute-in-jail
    publishers:
      - add-svn-revision-shorttext
      - scan-{warnscanner}-warnings
      - ftp:
          site: 'artifact.ci.freebsd.org'
          target: 'snapshot'
          source: 'src/release/artifact/**'
          remove-prefix: 'src/release/artifact'
      - clean-jail
#      - mail-notify
      - trigger-parameterized-builds:
        - project:
            - 'FreeBSD-{branch}-{arch}-images'
            - 'FreeBSD-{branch}-{arch}-testvm'
            - 'FreeBSD-{branch}-{arch}-LINT'
          condition: SUCCESS
          svn-revision: true
          property-file: trigger.property
    wrappers:
      - timestamps
      - timeout:
          timeout: 90
          timeout-var: 'BUILD_TIMEOUT'
          fail: true
          type: absolute

- job-template:
    disable_job_LINT: false
    defaults: global
    name: 'FreeBSD-{branch}-{arch}-LINT'
    disabled: '{disable_job_LINT}'
    node: jailer_slow
    scm:
      - 'FreeBSD-src-{branch}'
    properties:
      - inject:
          properties-content: |
            MOUNT_REPO=src
    builders:
      - checkout-scripts
      - setup-jail
      - execute-in-jail
    publishers:
      - add-svn-revision-shorttext
      - scan-clang-warnings
      - clean-jail
#      - mail-notify
    wrappers:
      - timestamps
      - timeout:
          timeout: 60
          timeout-var: 'BUILD_TIMEOUT'
          fail: true
          type: absolute

- job-template:
    disable_job_images: false
    defaults: global
    name: 'FreeBSD-{branch}-{arch}-images'
    disabled: '{disable_job_images}'
    node: jailer_slow
    scm:
      - 'FreeBSD-src-{branch}-empty'
    parameters:
      - string:
          name: SVN_REVISION
          description: "Subversion revision"
    properties:
      - inject:
          properties-content: |
            FBSD_BRANCH={branch}
    builders:
      - checkout-scripts
      - setup-jail
      - execute-in-jail
    publishers:
      - add-svn-revision-shorttext
      - ftp:
          site: 'artifact.ci.freebsd.org'
          target: 'snapshot'
          source: 'artifact/**'
          remove-prefix: 'artifact'
      - clean-jail
    wrappers:
      - timestamps
      - timeout:
          timeout: 60
          timeout-var: 'BUILD_TIMEOUT'
          fail: true
          type: absolute

- job-template:
    defaults: global
    name: 'FreeBSD-{branch}-{arch}-testvm'
    node: jailer_fast
    scm:
      - 'FreeBSD-src-{branch}-empty'
    parameters:
      - string:
          name: SVN_REVISION
          description: "Subversion revision"
    properties:
      - inject:
          properties-content: |
            FBSD_BRANCH={branch}
    builders:
      - checkout-scripts
      - setup-jail
      - execute-in-jail
    publishers:
      - add-svn-revision-shorttext
      - ftp:
          site: 'artifact.ci.freebsd.org'
          target: 'snapshot'
          source: 'artifact/**'
          remove-prefix: 'artifact'
      - clean-jail
      - trigger-parameterized-builds:
        - project:
            - 'FreeBSD-{branch}-{arch}-test'
          condition: SUCCESS
          svn-revision: true
          property-file: trigger.property
    wrappers:
      - timestamps
      - timeout:
          timeout: 30
          timeout-var: 'BUILD_TIMEOUT'
          fail: true
          type: absolute

- job-template:
    defaults: global
    name: 'FreeBSD-{branch}-{arch}-test'
    node: bhyve_host
    scm:
      - 'FreeBSD-src-{branch}-empty'
    properties:
      - inject:
          properties-content: |
            FBSD_BRANCH={branch}
    parameters:
      - string:
          name: SVN_REVISION
          description: "Subversion revision"
    builders:
      - checkout-scripts
      - execute-job-build-script
    publishers:
      - add-svn-revision-shorttext
      - publish-junit-results
#      - mail-notify
    wrappers:
      - timestamps
      - timeout:
          timeout: 90
          timeout-var: 'BUILD_TIMEOUT'
          fail: true
          type: absolute

- job-group:
    name: 'FreeBSD-{branch}-{arch}-ci'
    jobs:
       - 'FreeBSD-{branch}-{arch}-build'
       - 'FreeBSD-{branch}-{arch}-images'
       - 'FreeBSD-{branch}-{arch}-LINT'
       - 'FreeBSD-{branch}-{arch}-testvm'
       - 'FreeBSD-{branch}-{arch}-test'
